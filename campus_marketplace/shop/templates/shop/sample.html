
{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Checkout Page</title>

    <link rel="icon" type="image/png" href="{% static 'shop/images/favicon.png' %}">
    
    <link rel="shortcut icon" href="{% static 'shop/images/favicon.png' %}">
    <!-- Get the CSRF token for security when making a POST request -->
    {% csrf_token %} 
    
</head>
<body>
    <h1>Complete Your Order</h1>
    <!-- A container to display the shipping price later -->
    <p>Estimated Shipping Cost: <strong id="shipping-cost">N/A</strong></p>

    <!-- The Button -->
    <button id="quote-button">Get Lalamove Quote</button>

   <script>
    // Define all functions first
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function fetchShippingQuote() {
        // --- Your Lalamove Payload (this part is correct) ---
        const orderData ={
  "data": {
    "scheduleAt": "2025-12-03T16:45:00.00Z", // Must be future time
    "serviceType": "MOTORCYCLE",
    "language": "en_PH",
    "stops": [
      {
      // "lat": "14.5898", 
       // "lng": "120.9830",
        "address": "Natividad Almeda-Lopez corner A. Villegas and San Marcelino Streets, Ermita, Manila, Metro Manila, Philippines"
      },
      {
       // "lat": "14.6015", 
       // "lng": "120.9736",
        "address": "1018 Soler St, Binondo, Manila, 1006 Metro Manila, Philippines"
      }
    ],
    "item": {
      "quantity": "1",
      "weight": "SMALL"
    }
  }
};

        // Send an AJAX POST request to your Django view
        fetch('/api/get-shipping-quote/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('shipping-cost').innerText = `${data.currency} ${data.fee}`;
                alert('Shipping quote fetched successfully!');
            } else {
                // Shows the detailed error from your Django view
                alert('Error getting quote: ' + JSON.stringify(data.details || data.error)); 
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            alert('A network error occurred.');
        });
    }

    // --- FIX: Attach the listener after the DOM is fully loaded ---
    document.addEventListener('DOMContentLoaded', (event) => {
        const button = document.getElementById('quote-button');
        if (button) {
            button.addEventListener('click', fetchShippingQuote);
        }
    }
    );
</script>
</body>
</html>